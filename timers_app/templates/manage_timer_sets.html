<!DOCTYPE html>
{% load static %}
{% load format_tags %}
<html lang="en">
<head>
    <title>Dynamic Timers</title>
    <meta charset="utf-8">
    <meta name="title" content="Dynamic Timers">
    <meta name="description" content="Dynamic Timers lets you create, manage, and track multiple named timers with live updates. Perfect for productivity, time tracking, and focus.">
    <meta name="robots" content="INDEX,FOLLOW">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5.0, user-scalable=yes">
    <link rel="icon" type="image/x-icon" href="{% static 'img/favicon.png' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'css/mobile.css' %}">
    <link rel="stylesheet" href="{% static 'css/darkmode.css' %}">
    <link rel="stylesheet" href="{% static 'css/tabs.css' %}">
    <script>
        if (localStorage.getItem("darkMode") === "true") {
            document.documentElement.classList.add("dark-mode");
        }
    </script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-HFQFMJDLL2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      gtag('js', new Date());

      gtag('config', 'G-HFQFMJDLL2');
    </script>
</head>
<body class="container py-4" style="display: flex; justify-content: center;">
<div style="width: 540px">
    <div class="mb-2 d-flex align-items-center justify-content-between gap-2">
        <h1>Manage Timer Sets</h1>
        <div class="form-switch float-end">
            <li class="nav-item align-items-center d-flex">
                <i class="fas fa-sun"></i>
                <div class="ms-2 form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="checkbox" />
                </div>
                <i class="fas fa-moon"></i>
            </li>
        </div>
    </div>

    <!-- List existing sets -->
    {% for set in timer_sets %}
    <form method="POST" class="border p-3 mb-3 rounded">{% csrf_token %}
        <input type="hidden" name="action" value="update">
        <div class="mb-2">
            <label class="form-label fw-bold">Set Name</label>
            <input type="text" name="set_name" class="name-input-sets ts form-control" value="{{ set.name }}" required>
        </div>
        <div id="timers-{{ forloop.counter0 }}">
            <label class="form-label fw-bold">Timer Name(s)</label>
            {% for timer in set.timers %}
            <div class="d-flex gap-2 mb-2">
                <input type="text" name="timer_names" class="name-input-sets ts form-control" value="{{ timer.name }}" required>
                <input type="number" data-id="{{ forloop.counter0 }}" name="timer_minutes" class="form-control ts elapsed-input" step="0.1" min="0" value="{% if timer.elapsed %}{{ timer.elapsed|format_minutes }}{% else %}0.0{% endif %}" data-tab="{{ active_tab }}">
                <span data-timer data-id="{{ forloop.counter0 }}" data-elapsed="{{ timer.elapsed }}" data-tab="{{ active_tab }}" style="display: none;"></span>
                <button type="submit" name="action" value="delete_timer_row" class="btn btn-danger">ğŸ—‘ï¸</button>
                <input type="hidden" name="timer_row_index" value="{{ forloop.counter0 }}">
            </div>
            {% endfor %}
        </div>
        <div class="mt-3">
            <button type="button" class="btn btn-primary btn-sm mb-2 fw-bold" onclick="addTimerField('timers-{{ forloop.counter0 }}', {{ forloop.counter0 }})">â• Add Timer</button>
            <input type="hidden" name="set_index" value="{{ forloop.counter0 }}">
            <button type="submit" name="action" value="delete" class="btn btn-danger btn-sm mb-2 ms-2 fw-bold">ğŸ—‘ Delete set</button>
        </div>
    </form>
    {% empty %}
    <p>No timer sets yet.</p>
    {% endfor %}

    <hr>
    <!-- Add new set -->
    <h4 class="mt-4">â• Add New Timer Set</h4>
    <form method="POST" class="border p-3 rounded">{% csrf_token %}
        <input type="hidden" name="action" value="add">
        <button type="submit" class="mb-3 btn btn-success fw-bold">ğŸ’¾ Save New Set</button>
        <div class="mb-2">
            <label class="form-label fw-bold">Set Name</label>
            <input type="text" name="set_name" class="name-input-sets form-control" required>
        </div>
        <div id="new-timer-fields">
            <label class="form-label fw-bold">Timer Name(s)</label>
            <div class="d-flex gap-2 mb-2">
                <input type="text" name="timer_names" class="name-input-sets form-control" value="{{ timer.name }}" required>
                <input type="number" data-id="{{ forloop.counter0 }}" name="timer_minutes" class="form-control elapsed-input" step="0.1" min="0" value="{% if timer.elapsed %}{{ timer.elapsed|format_minutes }}{% else %}0.0{% endif %}" data-tab="{{ active_tab }}">
                <span data-timer data-id="{{ forloop.counter0 }}" data-elapsed="{{ timer.elapsed }}" data-tab="{{ active_tab }}" style="display: none;"></span>
                <button type="submit" name="action" value="delete_timer_row" class="btn btn-danger">ğŸ—‘ï¸</button>
                <input type="hidden" name="timer_row_index" value="{{ forloop.counter0 }}">
            </div>
        </div>
        <div class="mt-3">
            <button type="button" class="btn btn-sm btn-primary fw-bold" onclick="addTimerField('new-timer-fields')">â• Add Timer</button>
        </div>
    </form>

    <!-- Return -->
    <div class="text-center my-4">
      <a href="{% url 'index' %}" class="btn btn-outline-success btn-sm ms-2 fw-bold">â† Back</a>
    </div>

    <!-- Footer -->
    <footer class="fixed-bottom text-center py-2 bg-light border-top shadow-sm">
        <a href="https://github.com/watista/dynamic-timers" target="_blank" class="text-dark text-decoration-none fw-semibold">
            <img src="{% static 'img/github.png' %}" alt="GitHub" width="20" height="20" class="github-logo">
            <img src="{% static 'img/github-white.png' %}" alt="GitHub" width="20" height="20" class="github-logo-dark">
            View on <span class="text-secondary">GitHub</span>
        </a>
    </footer>

    <!-- JavaScript -->
    <div id="js-context"
         data-csrf-token="{{ csrf_token }}"
         data-reorder-url="{% url 'index' %}">
    </div>
    <script src="{% static 'js/utils.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const toggle = document.getElementById('checkbox');
            const isDark = localStorage.getItem('darkMode') === 'true';

            if (isDark) {
                document.body.classList.add('dark-mode');
                toggle.checked = true;
            }

            toggle.addEventListener('change', () => {
                document.body.classList.toggle('dark-mode');
                localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
            });

            const autoFocusInput = document.querySelector('input[data-autofocus="true"]');
            if (autoFocusInput) {
                autoFocusInput.focus();
                autoFocusInput.select();
            }

            document.querySelectorAll(".ts").forEach(input => {
                const form = input.closest("form");

                // Save on blur
                input.addEventListener("blur", () => {
                    if (form) {
                        const hidden = document.createElement("input");
                        hidden.type = "hidden";
                        hidden.name = "action";
                        hidden.value = "update";
                        form.appendChild(hidden);
                        form.submit();
                    }
                });

                // Save on Enter (prevent newlines or accidental submits)
                input.addEventListener("keydown", e => {
                    if (e.key === "Enter") {
                        e.preventDefault();
                        if (form) {
                            const hidden = document.createElement("input");
                            hidden.type = "hidden";
                            hidden.name = "action";
                            hidden.value = "update";
                            form.appendChild(hidden);
                            form.submit();
                        }
                    }
                });
            });
        });

        function addTimerField(containerId, setIndex) {
            const container = document.getElementById(containerId);

            document.querySelectorAll("input[data-autofocus]").forEach(el => el.removeAttribute("data-autofocus"));

            const wrapper = document.createElement("div");
            wrapper.className = "d-flex gap-2 mb-2";

            const nameInput = document.createElement("input");
            nameInput.type = "text";
            nameInput.name = "timer_names";
            nameInput.className = "name-input-sets form-control";
            nameInput.required = true;
            nameInput.setAttribute("data-autofocus", "true");

            const minutesInput = document.createElement("input");
            minutesInput.type = "number";
            minutesInput.name = "timer_minutes";
            minutesInput.className = "form-control elapsed-input";
            minutesInput.min = 0;
            minutesInput.step = "0.1";
            minutesInput.value = "0.0";

            const deleteBotton = document.createElement("button");
            deleteBotton.type = "submit";
            deleteBotton.name = "action";
            deleteBotton.className = "btn btn-danger";
            deleteBotton.value = "delete";
            deleteBotton.innerHTML = "ğŸ—‘ï¸";

            const rowIndexHidden = document.createElement("input");
            rowIndexHidden.type = "hidden";
            rowIndexHidden.name = "timer_row_index";
            rowIndexHidden.value = "-1";

            wrapper.appendChild(nameInput);
            wrapper.appendChild(minutesInput);
            wrapper.appendChild(deleteBotton);
            wrapper.appendChild(rowIndexHidden);
            container.appendChild(wrapper);

            setTimeout(() => {
                nameInput.focus();
                nameInput.select();
            }, 0);

            [nameInput, minutesInput].forEach(input => {
                input.addEventListener("blur", () => {
                    const form = container.closest("form");
                    const setIndex = form.querySelector('input[name="set_index"]')?.value;
                    const setName = form.querySelector('input[name="set_name"]')?.value || "";
                    const name = nameInput.value;
                    const minutes = minutesInput.value;
                    const csrf = document.querySelector("input[name=csrfmiddlewaretoken]").value;

                    const timerNames = Array.from(form.querySelectorAll('input[name="timer_names"]'))
                        .map(el => el.value.trim());

                    const timerMinutes = Array.from(form.querySelectorAll('input[name="timer_minutes"]'))
                        .map(el => el.value.trim());

                    const payload = new URLSearchParams();
                    payload.append("action", "update");
                    payload.append("set_index", setIndex);
                    payload.append("set_name", setName);

                    timerNames.forEach(name => payload.append("timer_names", name));
                    timerMinutes.forEach(minutes => payload.append("timer_minutes", minutes));

                    // Avoid empty names
                    if (!name.trim()) return;

                    fetch("/manage-timer-sets/", {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": csrf,
                            "Content-Type": "application/x-www-form-urlencoded"
                        },
                        body: payload
                    });
                });
            });
        }

        function deleteLastField(containerId) {
            const container = document.getElementById(containerId);
            const inputs = container.querySelectorAll('input[name="timer_names"]');
            if (inputs.length > 1) {
                container.removeChild(inputs[inputs.length - 1]);
            }
        }

    </script>
</div>
</body>
</html>
